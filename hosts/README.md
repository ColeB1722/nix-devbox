# Host Configurations

This directory contains host definitions (templates) for different deployment targets.
Each host imports the appropriate NixOS/darwin modules and sets machine-specific defaults.

## Available Hosts

| Host | Platform | Purpose |
|------|----------|---------|
| `devbox` | NixOS (bare-metal/VM) | Primary headless server |
| `devbox-wsl` | NixOS (WSL2) | Windows development |
| `devbox-desktop` | NixOS (bare-metal) | Headful Linux workstation |
| `macbook` | nix-darwin (macOS) | Local macOS workstation |

## Deployment

### Bare-Metal / VM Deployment

```bash
# Clone repository
git clone https://github.com/colebateman/nix-devbox.git
cd nix-devbox

# Generate hardware configuration (first time only)
nixos-generate-config --show-hardware-config > hosts/devbox/hardware-configuration.nix

# Build and deploy
sudo nixos-rebuild switch --flake .#devbox
```

### WSL2 Deployment

```powershell
# Enable WSL2 with systemd (PowerShell as Admin)
wsl --install -d NixOS
wsl --set-default NixOS
```

```bash
# Inside WSL
cd /mnt/c/Users/YourName/repos
git clone https://github.com/colebateman/nix-devbox.git
cd nix-devbox

# Deploy (no hardware-configuration.nix needed for WSL)
sudo nixos-rebuild switch --flake .#devbox-wsl
```

### Verify Deployment

After deployment, verify the system is operational:

```bash
# Check SSH access (from another machine on your tailnet)
ssh user@devbox.tailnet

# Verify Tailscale is connected
tailscale status

# Check Podman (if enabled)
podman --version
```

## Platform Differences

### Bare-Metal (`devbox`)

- Full kernel WireGuard support for Tailscale
- Direct hardware access
- Podman with rootless containers
- Supports Hyprland (opt-in, for headful deployments)

### WSL2 (`devbox-wsl`)

- Uses wireguard-go for Tailscale (userspace TUN)
- No bootloader configuration (Windows handles boot)
- Podman runs inside WSL
- No GPU/display support (Hyprland not available)
- Interop with Windows filesystem and commands

## Consumer Setup

These host definitions are **templates** that don't include personal data.
Consumers must provide:

1. **Hardware configuration** (bare-metal only):
   ```nix
   # hosts/devbox/hardware-configuration.nix
   # Generated by: nixos-generate-config --show-hardware-config
   ```

2. **User data** (`users.nix`):
   ```nix
   {
     youruser = {
       name = "youruser";
       uid = 1000;
       # ... other fields
     };
     allUserNames = [ "youruser" ];
     # ...
   }
   ```

## Troubleshooting

### SSH Connection Refused

```bash
# Check SSH service
sudo systemctl status sshd

# Verify Tailscale is connected
tailscale status

# Check firewall
sudo iptables -L -n | grep 22
```

### Podman Issues

```bash
# Check Podman socket
podman info

# List running containers
podman ps -a

# Check container logs
podman logs <container-name>
```

### WSL-Specific Issues

```bash
# Check WSL version
wsl --version

# Verify systemd is enabled
systemctl --version

# Check Tailscale interface
ip addr show tailscale0

# If Tailscale SSH not working, ensure NOT using userspace-networking
# WSL supports /dev/net/tun, so wireguard-go should work
```
