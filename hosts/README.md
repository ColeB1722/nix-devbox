# Host Configurations

This directory contains host definitions (templates) for different deployment targets.
Each host imports the appropriate NixOS/darwin modules and sets machine-specific defaults.

## Available Hosts

| Host | Platform | Purpose | Orchestrator |
|------|----------|---------|--------------|
| `devbox` | NixOS (bare-metal/VM) | Primary headless server | ✅ Enabled |
| `devbox-wsl` | NixOS (WSL2) | Windows development | ✅ Enabled |
| `devbox-desktop` | NixOS (bare-metal) | Headful Linux workstation | ❌ No |
| `macbook` | nix-darwin (macOS) | Local macOS workstation | ❌ No |

## Orchestrator Deployment

The orchestrator hosts dev containers that are accessible via Tailscale SSH.
Both `devbox` (bare-metal) and `devbox-wsl` configurations include the orchestrator.

### Bare-Metal / VM Deployment

```bash
# Clone repository
git clone https://github.com/your-org/nix-devbox.git
cd nix-devbox

# Generate hardware configuration (first time only)
nixos-generate-config --show-hardware-config > hosts/devbox/hardware-configuration.nix

# Build and deploy
sudo nixos-rebuild switch --flake .#devbox
```

### WSL2 Deployment

```powershell
# Enable WSL2 with systemd (PowerShell as Admin)
wsl --install -d NixOS
wsl --set-default NixOS
```

```bash
# Inside WSL
cd /mnt/c/Users/YourName/repos
git clone https://github.com/your-org/nix-devbox.git
cd nix-devbox

# Deploy (no hardware-configuration.nix needed for WSL)
sudo nixos-rebuild switch --flake .#devbox-wsl
```

### Verify Deployment

After deployment, verify the orchestrator is operational:

```bash
# Check SSH access (from another machine on your tailnet)
ssh user@devbox.tailnet

# Verify Podman is running
podman --version
podman ps

# Check devbox-ctl is available
devbox-ctl --help

# Verify 1Password CLI (if configured)
op --version
```

## Platform Differences

### Bare-Metal (`devbox`)

- Full kernel WireGuard support for Tailscale
- Direct hardware access
- Podman with rootless containers
- Supports Hyprland (opt-in, for headful deployments)

### WSL2 (`devbox-wsl`)

- Uses wireguard-go for Tailscale (userspace TUN)
- No bootloader configuration (Windows handles boot)
- Podman runs inside WSL
- No GPU/display support (Hyprland not available)
- Interop with Windows filesystem and commands

## Consumer Setup

These host definitions are **templates** that don't include personal data.
Consumers must provide:

1. **Hardware configuration** (bare-metal only):
   ```nix
   # hosts/devbox/hardware-configuration.nix
   # Generated by: nixos-generate-config --show-hardware-config
   ```

2. **User data** (`users.nix`):
   ```nix
   {
     youruser = {
       name = "youruser";
       uid = 1000;
       # ... other fields
     };
     allUserNames = [ "youruser" ];
     # ...
   }
   ```

3. **1Password Service Account** (for orchestrator):
   - Create Service Account in 1Password
   - Set `OP_SERVICE_ACCOUNT_TOKEN` on the orchestrator
   - Create `{username}-tailscale-authkey` items in your vault

4. **Tailscale auth keys** (in 1Password):
   - Generate auth keys with tags: `tag:devcontainer`, `tag:{username}-container`
   - Store in 1Password vault as `{username}-tailscale-authkey`

## Orchestrator Features

When enabled, the orchestrator provides:

- **Podman** for rootless container management
- **devbox-ctl** CLI for container lifecycle operations
- **1Password CLI** (`op`) for secret retrieval
- **Git and GitHub CLI** for repository management
- **Automatic cleanup** of idle/stopped containers

### devbox-ctl Commands

```bash
# Create a new dev container
devbox-ctl create my-project

# List your containers
devbox-ctl list

# Stop/start/destroy containers
devbox-ctl stop my-project
devbox-ctl start my-project
devbox-ctl destroy my-project

# View container status and logs
devbox-ctl status my-project
devbox-ctl logs my-project -f
```

### Container Lifecycle

Default lifecycle settings (configurable in `users.nix`):

| Setting | Default | Description |
|---------|---------|-------------|
| `maxPerUser` | 5 | Max containers per user |
| `maxGlobal` | 7 | Max containers on orchestrator |
| `defaultCpu` | 2 | CPU cores per container |
| `defaultMemory` | 4G | RAM per container |
| `idleStopDays` | 7 | Auto-stop after N days idle |
| `stoppedDestroyDays` | 14 | Auto-destroy after N days stopped |

## Troubleshooting

### SSH Connection Refused

```bash
# Check SSH service
sudo systemctl status sshd

# Verify Tailscale is connected
tailscale status

# Check firewall
sudo iptables -L -n | grep 22
```

### Podman Issues

```bash
# Check Podman socket
podman info

# List running containers
podman ps -a

# Check container logs
podman logs <container-name>
```

### devbox-ctl Issues

```bash
# Enable debug output
DEVBOX_DEBUG=true devbox-ctl list

# Check registry file
cat ~/.local/share/devbox/containers.json | jq

# Verify 1Password authentication
op vault list
```

### WSL-Specific Issues

```bash
# Check WSL version
wsl --version

# Verify systemd is enabled
systemctl --version

# Check Tailscale interface
ip addr show tailscale0

# If Tailscale SSH not working, ensure NOT using userspace-networking
# WSL supports /dev/net/tun, so wireguard-go should work
```

## Related Documentation

- [Container README](../containers/README.md) - Container build and usage
- [Quickstart Guide](../specs/009-devcontainer-orchestrator/quickstart.md) - Full deployment guide
- [CLI Contract](../specs/009-devcontainer-orchestrator/contracts/README.md) - devbox-ctl reference