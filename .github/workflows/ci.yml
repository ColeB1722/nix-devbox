# CI workflow for nix-devbox
#
# Runs on every push and pull request to validate:
# 1. Flake structure and pre-commit hooks (nix flake check)
# 2. NixOS configuration builds successfully
#
# Uses DeterminateSystems Nix installer for modern flake support
# and magic-nix-cache for faster builds.

name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  check:
    name: Flake Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run flake check
        run: nix flake check

  build:
    name: Build NixOS Configuration
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build devbox configuration
        run: nix build .#nixosConfigurations.devbox.config.system.build.toplevel
