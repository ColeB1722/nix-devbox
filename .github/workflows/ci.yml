# CI workflow for nix-devbox
#
# Runs on:
# - Push to main or release/* branches
# - PRs targeting main or release/* branches
#
# Pipeline:
# - release/* branches: Full validation (format → check → build)
# - main branch: Lightweight validation (format → check) → publish to FlakeHub
#
# Rationale: Code is fully validated on release branches before merging to main.
# Main branch only needs quick validation before publishing to FlakeHub.
# FlakeHub Cache handles builds on-demand when consumers pull the flake.
#
# Feature branches get no CI until they open a PR.
# Pre-commit hooks handle local validation.
#
# Uses DeterminateSystems actions with FlakeHub Cache for fast builds:
# - determinate-nix-action: Installs Nix with FlakeHub integration
# - flakehub-cache-action: Pushes/pulls from FlakeHub binary cache
# - flakehub-push: Publishes flake with resolved store paths

name: CI

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
      - 'release/**'

# Required for FlakeHub Cache and FlakeHub publish authentication
permissions:
  id-token: write
  contents: read

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Full CI: release/* branches get complete validation including builds
  # ─────────────────────────────────────────────────────────────────────────────
  ci-full:
    name: Full CI (Format, Check, Build)
    runs-on: ubuntu-latest
    # Run on release branches (push or PR targeting release)
    if: |
      startsWith(github.ref, 'refs/heads/release/') ||
      (github.event_name == 'pull_request' && startsWith(github.base_ref, 'release/'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Setup FlakeHub Cache
        uses: DeterminateSystems/flakehub-cache-action@main

      - name: Check formatting
        run: nix fmt -- --check .

      - name: Run flake check
        run: nix flake check

      - name: Build NixOS configurations
        run: |
          nix build .#nixosConfigurations.devbox.config.system.build.toplevel
          nix build .#nixosConfigurations.devbox-wsl.config.system.build.toplevel

  # ─────────────────────────────────────────────────────────────────────────────
  # Quick CI: main branch gets lightweight validation (no build)
  # ─────────────────────────────────────────────────────────────────────────────
  ci-quick:
    name: Quick CI (Format, Check)
    runs-on: ubuntu-latest
    # Run on main branch (push or PR targeting main)
    if: |
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Setup FlakeHub Cache
        uses: DeterminateSystems/flakehub-cache-action@main

      - name: Check formatting
        run: nix fmt -- --check .

      - name: Run flake check
        run: nix flake check

  # ─────────────────────────────────────────────────────────────────────────────
  # Publish: Push to FlakeHub after quick validation passes
  # ─────────────────────────────────────────────────────────────────────────────
  publish:
    name: Publish to FlakeHub
    runs-on: ubuntu-latest
    needs: ci-quick
    # Only publish on push to main (not PRs, not release branches)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Setup FlakeHub Cache
        uses: DeterminateSystems/flakehub-cache-action@main

      - name: Publish flake to FlakeHub
        uses: DeterminateSystems/flakehub-push@main
        with:
          # Publish as coal-bap/nix-devbox on FlakeHub
          name: coal-bap/nix-devbox
          visibility: public
          # Rolling tag tracks latest main branch
          rolling: true
          # Include resolved store paths for faster downstream builds
          # Consumers can fetch pre-built derivations from FlakeHub Cache
          include-output-paths: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Deploy Job (Manual Example)
  # ─────────────────────────────────────────────────────────────────────────────
  # Uncomment and configure when ready to enable automated deployment.
  # Requires:
  #   1. Tailscale auth key stored as secret: TAILSCALE_AUTHKEY
  #   2. SSH key for devbox stored as secret: DEPLOY_SSH_KEY
  #   3. Target machine accessible via Tailscale
  #
  # deploy:
  #   name: Deploy to Devbox
  #   runs-on: ubuntu-latest
  #   needs: publish
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Install Nix
  #       uses: DeterminateSystems/determinate-nix-action@v3
  #
  #     - name: Setup Tailscale
  #       uses: tailscale/github-action@v2
  #       with:
  #         authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
  #
  #     - name: Setup SSH key
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
  #         chmod 600 ~/.ssh/id_ed25519
  #         ssh-keyscan -H devbox.tailnet >> ~/.ssh/known_hosts
  #
  #     - name: Deploy to devbox
  #       run: |
  #         # Option A: Build locally and push to target
  #         nixos-rebuild switch \
  #           --flake .#devbox \
  #           --target-host devuser@devbox.tailnet \
  #           --use-remote-sudo
  #
  #         # Option B: SSH and pull from FlakeHub on target
  #         # ssh devuser@devbox.tailnet "sudo nixos-rebuild switch --flake flakehub:ColeB1722/nix-devbox#devbox"
